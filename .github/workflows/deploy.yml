name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    types: [closed]
  workflow_dispatch:

env:
  COMPOSE_PROJECT_NAME: xiaoyi

jobs:
  deploy:
    name: ğŸš€ Build and Deploy
    runs-on: self-hosted
    
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false  # ä¸æ‹‰å– submodule

      - name: ğŸŒ Get server IP
        id: ip
        run: |
          if [ -n "${{ vars.SERVER_IP }}" ]; then
            SERVER_IP="${{ vars.SERVER_IP }}"
          else
            SERVER_IP=$(hostname -I | awk '{print $1}')
          fi
          echo "SERVER_IP=${SERVER_IP}" >> $GITHUB_OUTPUT
          echo "ğŸ“ æœåŠ¡å™¨ IP: ${SERVER_IP}"

      - name: ğŸ“ Create .env file
        run: |
          cat > .env << EOF
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          NEXT_PUBLIC_API_URL=http://${{ steps.ip.outputs.SERVER_IP }}:18000
          EOF
          
          cat > backend/.env << EOF
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
          HOST=0.0.0.0
          PORT=8000
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_DB=0
          RAG_SERVICE_URL=http://{{ secrets.RAG_SERVICE_IP }}:8000
          EOF
          
          echo "ğŸ“ NEXT_PUBLIC_API_URL=http://${{ steps.ip.outputs.SERVER_IP }}:18000"
          echo "ğŸ“ Redisé…ç½®: redis:6379"

      - name: ğŸ›‘ Stop existing containers
        run: docker compose down --remove-orphans || true

      - name: ğŸ”¨ Build images
        run: docker compose build

      - name: ğŸš€ Start containers
        run: docker compose up -d

      - name: â³ Wait for services
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 15
          
          for i in {1..20}; do
            if docker compose exec -T redis redis-cli ping > /dev/null 2>&1; then
              echo "âœ… Rediså°±ç»ª"
              break
            fi
            [ $i -eq 20 ] && { echo "âŒ Redisè¶…æ—¶"; docker compose logs redis; exit 1; }
            echo "ç­‰å¾…Redis... ($i/20)"
            sleep 2
          done
          
          for i in {1..30}; do
            if curl -sf http://localhost:18000/health > /dev/null 2>&1; then
              echo "âœ… åç«¯å°±ç»ª"
              break
            fi
            [ $i -eq 30 ] && { echo "âŒ åç«¯è¶…æ—¶"; docker compose logs backend; exit 1; }
            echo "ç­‰å¾…åç«¯... ($i/30)"
            sleep 3
          done
          
          for i in {1..20}; do
            if curl -sf http://localhost:13000 > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯å°±ç»ª"
              break
            fi
            [ $i -eq 20 ] && { echo "âŒ å‰ç«¯è¶…æ—¶"; docker compose logs frontend; exit 1; }
            echo "ç­‰å¾…å‰ç«¯... ($i/20)"
            sleep 2
          done

      - name: âœ… Health check
        run: |
          echo "=========================================="
          docker compose ps
          echo "=========================================="
          docker compose exec -T redis redis-cli ping && echo "Redis OK"
          curl -sf http://localhost:18000/health && echo "åç«¯ OK"
          curl -sf http://localhost:13000 > /dev/null && echo "å‰ç«¯ OK"

      - name: ğŸ§¹ Cleanup
        run: docker image prune -f --filter "until=24h"

      - name: ğŸ“¢ Notify WPS
        if: always()
        env:
          WPS_WEBHOOK: ${{ secrets.WPS_WEBHOOK }}
        run: |
          if [ -z "$WPS_WEBHOOK" ]; then
            echo "WPS_WEBHOOK æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            ICON="âœ…"; TITLE="éƒ¨ç½²æˆåŠŸ"
          else
            ICON="âŒ"; TITLE="éƒ¨ç½²å¤±è´¥"
          fi
          
          CONTENT="## ${ICON} ${TITLE}\n\n**åˆ†æ”¯**: ${{ github.ref_name }}\n**æäº¤è€…**: ${{ github.actor }}\n**æäº¤**: ${{ github.event.head_commit.message }}\n\nğŸŒ å‰ç«¯: http://${{ steps.ip.outputs.SERVER_IP }}:13000\nğŸ”Œ åç«¯: http://${{ steps.ip.outputs.SERVER_IP }}:18000"
          
          curl -sS -X POST "$WPS_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"msgtype\":\"markdown\",\"markdown\":{\"text\":\"${CONTENT}\"}}" || true

      - name: ğŸ“Š Summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯: http://${{ steps.ip.outputs.SERVER_IP }}:13000"
          echo "ğŸ”Œ åç«¯: http://${{ steps.ip.outputs.SERVER_IP }}:18000"
          echo "ğŸ“š API:  http://${{ steps.ip.outputs.SERVER_IP }}:18000/docs"
          echo "=========================================="
